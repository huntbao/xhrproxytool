!function(){"use strict";var e={init:function(){this.initConnect(),this.initWebRequest()},initConnect:function(){var e=this;chrome.runtime.onConnect.addListener(function(t){switch(t.name){case"send-request":e.sendRequestHandler(t);break;case"page-script-error":e.showPageScriptError(t);break;case"exec-scripts":e.execScriptsHandler(t)}}),chrome.runtime.onMessageExternal.addListener(function(e,t,n){"inject-content-script"===e.name&&chrome.tabs.executeScript(t.tab.id,{file:"js/xhrproxy.page.js"})})},initWebRequest:function(){chrome.webRequest.onBeforeSendHeaders.addListener(function(e){var t=chrome.i18n.getMessage("@@extension_id"),n=function(e,t,n){return e&&e.length>0?e.filter(function(e){return e[t]===n})[0]:null},r=n(e.requestHeaders,"name","Origin");if(e.initiator&&e.initiator.substring(19)===t||r&&r.value&&r.value.substring(19)===t){var a=JSON.parse(n(e.requestHeaders,"name","X-Set-Headers").value);for(var s in a){var i=n(e.requestHeaders,"name",s);i?"Cookie"===s?i.value+=";"+a[s]:i.value=a[s]:e.requestHeaders.push({name:s,value:a[s]})}return e.requestHeaders.splice(e.requestHeaders.findIndex(function(e){return"X-Set-Headers"===e.name}),1),{requestHeaders:e.requestHeaders}}},{urls:["<all_urls>"]},["blocking","requestHeaders"])},sendRequestHandler:function(e){e.onMessage.addListener(function(t){var n=new XMLHttpRequest,r="",a=t.method.toUpperCase(),s=t.url.trim();/^https?\:/.test(s)||(s="http://"+s);var i={};Object.keys(t.headers||{}).forEach(function(e){i[e.toLowerCase()]=t.headers[e]}),i["content-type"]||(i["content-type"]="application/x-www-form-urlencoded; charset=UTF-8");var o=[];Object.keys(t.data).forEach(function(e){var n=t.data[e];n.__isFile__&&o.push(new Promise(function(r,a){var s=new XMLHttpRequest;s.open("GET",n.blobUrl,!0),s.responseType="blob",s.onload=function(a){if(200===this.status){var s=this.response;t.data[e]=new File([s],n.filename,{type:s.type}),r()}},s.send()}))});var c=function(e){var t=Object.prototype.toString,n=["Object","Array"];return n.map(function(e){return"[object "+e+"]"}).indexOf(t.call(e))!==-1};if(/^(number|string|boolean)$/.test(typeof t.data))r=encodeURIComponent(String(t.data));else for(var d in t.data)t.data[d].__isFile__||(r&&(r+="&"),r+=encodeURIComponent(d)+"="+encodeURIComponent(c(t.data[d])?JSON.stringify(t.data[d]):t.data[d]));var u=new FormData,f=function(e,t,n){var r=n?encodeURIComponent:function(e){return e};Object.keys(t).forEach(function(n){var a=r(n),s=r(c(t[n])?JSON.stringify(t[n]):t[n]);e.append(a,s)})};"GET"===a?(r&&(s+="?"+r),o.length&&(o.length=0)):o.length?(Promise.all(o).then(function(){f(u,t.data),n.send(u)}),delete i["content-type"]):"application/json"===i["content-type"]?r=JSON.stringify(t.data):"multipart/form-data"===i["content-type"]?(f(u,t.data),r=u):~i["content-type"].indexOf("application/x-www-form-urlencoded")||(r=JSON.stringify(t.data)),n.open(a,s,!0);var l={},p=["referer","accept-charset","accept-encoding","cookie","date","origin","user-agent"];for(var m in i)p.indexOf(m)!==-1?l[m]=i[m]:n.setRequestHeader(m,i[m]);n.setRequestHeader("X-Set-Headers",JSON.stringify(l)),n.onreadystatechange=function(){if(4===this.readyState){var r={},a=["readyState","response","responseText","responseType","responseURL","responseXML","status","statusText","timeout","withCredentials"];a.forEach(function(e){r[e]=n[e]}),r.responseHeaders=this.getAllResponseHeaders(),chrome.tabs.sendMessage(e.sender.tab.id,{name:"send-request-res",data:n.responseText,reqData:t,xhr:r})}},o.length||n.send(r)})},showPageScriptError:function(e){var t=localStorage.xhr_proxy_tool_js_error_notify;"true"===t&&e.onMessage.addListener(function(e){var t=new Notification("脚本错误:",{icon:"./js/image.png",body:e.data.message+"\n"+e.data.filename+"\n"+e.data.lineno});setTimeout(function(){t.close()},3e3)})},execScriptsHandler:function(e){e.onMessage.addListener(function(t){var n=e.sender.tab.id,r=t.data;chrome.webNavigation.getAllFrames({tabId:n},function(e){console.log(r);var t=e.find(function(e){return e.url.startsWith(r.targetFrameUrl)});t?chrome.tabs.executeScript({code:r.scripts+";jasmineRun();",frameId:t.frameId}):console.log("没有找到目标 iframe 地址: "+r.targetFrameUrl)})})}};e.init()}();